language: perl
dist: jessie

sudo: enabled

cache:
  directories:
    - $HOME/server

before_cache:
  rm -rf $HOME/server/mysql-test

before_install:
- cpanm -n DBI DBD::mysql
- sudo apt-get install libaio1 libaio-dev libjemalloc1 gdb

env:
- TYPE=undo-recovery                                   COMPRESSION=none       PAGE_SIZE=all

install:
- cd $HOME
- export BASEDIR=$HOME/server
- export RQG_HOME=$HOME/rqg
- export CMAKE_OPTIONS="-DCMAKE_BUILD_TYPE=Debug -DPLUGIN_SPHINX=NO -DPLUGIN_TOKUDB=NO -DPLUGIN_ROCKSDB=NO -DPLUGIN_MROONGA=NO -DPLUGIN_FEDERATED=NO -DPLUGIN_FEDERATEDX=NO -DPLUGIN_CONNECT=NO -DPLUGIN_SPIDER=NO -DWITH_MARIABACKUP=OFF"
# SERVER_BRANCH can be redefined in build variables
- if [ -z "$SERVER_BRANCH" ] ; then SERVER=10.3 ; else SERVER=$SERVER_BRANCH ; fi
- git clone https://github.com/elenst/rqg --branch scenarios rqg
- git clone https://github.com/MariaDB/server --depth=1 --branch $SERVER src

script:

- cd $HOME
- . $TRAVIS_BUILD_DIR/scripts/build_if_not_cached.sh
- cd $RQG_HOME

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=4 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=4 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=4 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=2 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=2 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=2 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=1 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=1 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- perl /home/travis/rqg//runall-new.pl --grammar=conf/mariadb/oltp_and_ddl.yy --gendata-advanced --mysqld=--server-id=111 --duration=200 --basedir=/home/travis/server --mysqld=--innodb-page-size=4K --mysqld=--innodb-compression-algorithm=none --mysqld=--loose-innodb-file-format=Barracuda --mysqld=--loose-innodb-file-per-table=1 --gendata=conf/mariadb/innodb_upgrade.zz --no-mask --seed=1508721187 --threads=1 --queries=100M --mysqld=--loose-max-statement-time=20 --mysqld=--loose-lock-wait-timeout=20 --mysqld=--loose-innodb-lock-wait-timeout=10 --mysqld=--loose-innodb_log_compressed_pages=on --mtr-build-thread=300 --vardir1=/home/travis/logs/vardir1 || cat /home/travis/logs/vardir1/mysql.log

- cd $HOME
#- . $TRAVIS_BUILD_DIR/scripts/collect_failure_info.sh $HOME/logs
#- perl $TRAVIS_BUILD_DIR/scripts/parse_upgrade_logs.pl --mode=jira --nowarnings $HOME/logs/trial*
#- perl $TRAVIS_BUILD_DIR/scripts/parse_upgrade_logs.pl --mode=kb --nowarnings $HOME/logs/trial*
#- perl $TRAVIS_BUILD_DIR/scripts/parse_upgrade_logs.pl --mode=text --nowarnings $HOME/logs/trial*
